<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>첨단 제품 제조 경영 게임(feat 희귀원소 경매)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn-hover:hover {
      transform: scale(1.05);
      background-color: #2563eb;
      transition: all 0.3s ease;
    }
    .btn-hover:active {
      transform: scale(0.95);
    }
    .spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .spinner::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 40px;
      height: 40px;
      border: 4px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      z-index: 10000;
      text-align: center;
      max-width: 90%;
    }
  </style>
</head>
<body class="bg-blue-100 min-h-screen flex items-center justify-center">
  <div id="app" class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
    <h1 class="text-2xl font-bold text-center mb-6 text-blue-600">첨단 제품 제조 경영 게임(feat 희귀원소 경매)</h1>
    
    <!-- Page 1: Group Name -->
    <div id="page1" class="space-y-4">
      <p class="text-center text-gray-700">Host가 알려준 단체명을 입력합니다. 대소문자 구분해서 정확히 입력해 주세요.</p>
      <input type="text" id="groupName" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="단체명 입력">
      <button onmouseup="nextPage(1)" class="w-full bg-blue-500 text-white p-2 rounded btn-hover">다음</button>
    </div>

    <!-- Page 2: Team Name -->
    <div id="page2" class="hidden space-y-4">
      <p id="groupNameDisplay" class="text-center text-blue-600 font-semibold"></p>
      <select id="teamName" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">팀을 선택하세요.</option>
      </select>
      <div class="flex space-x-2">
        <button onmouseup="prevPage(2)" class="w-1/2 bg-gray-200 text-gray-700 p-2 rounded btn-hover">뒤로 가기</button>
        <button onmouseup="nextPage(2)" class="w-1/2 bg-blue-500 text-white p-2 rounded btn-hover">다음</button>
      </div>
    </div>

    <!-- Page 3: Round Selection -->
    <div id="page3" class="hidden space-y-4">
      <p id="teamDisplay" class="text-center text-blue-600 font-semibold"></p>
      <select id="round" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">라운드를 선택하세요.</option>
      </select>
      <div class="flex space-x-2">
        <button onmouseup="prevPage(3)" class="w-1/2 bg-gray-200 text-gray-700 p-2 rounded btn-hover">뒤로 가기</button>
        <button onmouseup="nextPage(3)" class="w-1/2 bg-blue-500 text-white p-2 rounded btn-hover">다음</button>
      </div>
    </div>

    <!-- Page 4: Purchase Price -->
    <div id="page4" class="hidden space-y-4">
      <p id="roundDisplay" class="text-center text-blue-600 font-semibold"></p>
      <p class="text-center text-gray-700">개당 얼마에 구매하겠습니까?</p>
      <select id="purchasePrice" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">입찰 가격을 선택하세요.</option>
      </select>
      <div class="flex space-x-2">
        <button onmouseup="prevPage(4)" class="w-1/2 bg-gray-200 text-gray-700 p-2 rounded btn-hover">뒤로 가기</button>
        <button onmouseup="nextPage(4)" class="w-1/2 bg-blue-500 text-white p-2 rounded btn-hover">다음</button>
      </div>
    </div>

    <!-- Page 5: Political Economic Situation -->
    <div id="page5" class="hidden space-y-4">
      <p id="purchasePriceDisplay" class="text-center text-blue-600 font-semibold"></p>
      <p class="text-center text-gray-700">정치경제상황변화</p>
      <select id="politicalEconomicSituation" class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">정치경제상황 변화를 선택하세요.</option>
        <option value="1">1</option>
        <option value="2">2</option>
      </select>
      <div class="flex space-x-2">
        <button onmouseup="prevPage(5)" class="w-1/2 bg-gray-200 text-gray-700 p-2 rounded btn-hover">뒤로 가기</button>
        <button id="submitBtn" onmouseup="nextPage(5)" class="w-1/2 bg-green-500 text-white p-2 rounded btn-hover">제출하기</button>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div id="spinner" class="spinner"></div>

    <!-- Popup -->
    <div id="popup" class="popup">
      <p id="popupMessage" class="text-lg text-blue-800 mb-4"></p>
      <button onmouseup="closePopup()" class="w-full bg-blue-500 text-white p-2 rounded btn-hover">확인</button>
    </div>
  </div>

  <script>
    let currentPage = 1;
    let groupName = '';
    let teamName = '';
    let round = '';
    let purchasePrice = '';
    let politicalEconomicSituation = '';
    let isSubmitting = false;

    // Initialize select options
    function initializeSelects() {
      const teamSelect = document.getElementById('teamName');
      const roundSelect = document.getElementById('round');
      const priceSelect = document.getElementById('purchasePrice');

      for (let i = 1; i <= 60; i++) {
        const option = new Option(`${i}팀`, `${i}팀`);
        teamSelect.appendChild(option);
      }

      for (let i = 1; i <= 16; i++) {
        const option = new Option(`${i}라운드`, `${i}라운드`);
        roundSelect.appendChild(option);
      }
      roundSelect.value = '1라운드'; // Default to 1라운드

      for (let i = 1; i <= 25; i++) {
        const option = new Option(i, i);
        priceSelect.appendChild(option);
      }
    }

    // Page navigation
    function showPage(page) {
      document.querySelectorAll('#app > div').forEach(div => div.classList.add('hidden'));
      document.getElementById(`page${page}`).classList.remove('hidden');
      currentPage = page;
    }

    function nextPage(page) {
      if (page === 1) {
        groupName = document.getElementById('groupName').value.trim();
        if (!groupName) {
          showPopup('단체명을 입력해주세요.');
          return;
        }
        document.getElementById('groupNameDisplay').textContent = `단체명: ${groupName}`;
        showPage(2);
      } else if (page === 2) {
        teamName = document.getElementById('teamName').value;
        if (!teamName) {
          showPopup('팀명을 선택해주세요.');
          return;
        }
        document.getElementById('teamDisplay').textContent = `팀명: ${teamName}`;
        showPage(3);
      } else if (page === 3) {
        round = document.getElementById('round').value;
        if (!round) {
          showPopup('라운드를 선택해주세요.');
          return;
        }
        document.getElementById('roundDisplay').textContent = `라운드: ${round}`;
        showPage(4);
      } else if (page === 4) {
        purchasePrice = document.getElementById('purchasePrice').value;
        if (!purchasePrice) {
          showPopup('구매 가격을 선택해주세요.');
          return;
        }
        document.getElementById('purchasePriceDisplay').textContent = `구매 가격: ${purchasePrice}`;
        showPage(5);
      } else if (page === 5) {
        politicalEconomicSituation = document.getElementById('politicalEconomicSituation').value;
        if (!politicalEconomicSituation) {
          showPopup('정치경제상황변화를 선택해주세요.');
          return;
        }
        submitData();
      }
    }

    function prevPage(page) {
      showPage(page - 1);
    }

    // Data submission
    function submitData() {
      if (isSubmitting) return;
      isSubmitting = true;

      // Re-fetch values from DOM to ensure synchronization
      groupName = document.getElementById('groupName').value.trim();
      teamName = document.getElementById('teamName').value;
      round = document.getElementById('round').value;
      purchasePrice = document.getElementById('purchasePrice').value;
      politicalEconomicSituation = document.getElementById('politicalEconomicSituation').value;

      // Validate fields
      const missingFields = [];
      if (!groupName) missingFields.push('단체명');
      if (!teamName) missingFields.push('팀명');
      if (!round) missingFields.push('라운드');
      if (!purchasePrice) missingFields.push('구매 가격');
      if (!politicalEconomicSituation) missingFields.push('정치경제상황변화');

      if (missingFields.length > 0) {
        console.log('Missing fields:', missingFields);
        showPopup(`다음 필드를 입력해주세요: ${missingFields.join(', ')}`);
        isSubmitting = false;
        return;
      }

      const spinner = document.getElementById('spinner');
      const submitBtn = document.getElementById('submitBtn');
      spinner.style.display = 'flex';
      submitBtn.disabled = true;

      const data = { groupName, teamName, round, purchasePrice, politicalEconomicSituation };
      console.log('Submitting:', data);

      fetch('https://script.google.com/macros/s/AKfycbwgvWRWOqM4rpB6MPJwDoPni4U70BfVhwyET_rjZ2rucaVBdVFVrci07pWOlAfvM2GR/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(() => {
        handleSubmissionSuccess(groupName, teamName, round);
      })
      .catch(() => {
        handleSubmissionSuccess(groupName, teamName, round); // Handle as success due to no-cors
      });
    }

    // Handle successful submission
    function handleSubmissionSuccess(groupName, teamName, round) {
      const spinner = document.getElementById('spinner');
      const submitBtn = document.getElementById('submitBtn');
      spinner.style.display = 'none';

      const currentRoundNum = parseInt(round.match(/\d+/)[0]);
      if (currentRoundNum < 16) {
        showPopup(`${groupName}, ${teamName}, ${round} 내용이 잘 입력됐습니다.`);
        document.getElementById('popup').dataset.nextPage = 3;
        const nextRound = `${currentRoundNum + 1}라운드`;
        document.getElementById('round').value = nextRound;
      } else {
        showPopup('모든 입력이 완료되었습니다!');
        document.getElementById('popup').dataset.nextPage = 1;
      }

      // Reset fields for next round
      document.getElementById('purchasePrice').value = '';
      document.getElementById('politicalEconomicSituation').value = '';
      purchasePrice = '';
      politicalEconomicSituation = '';

      setTimeout(() => {
        submitBtn.disabled = false;
        isSubmitting = false;
      }, 3000);
    }

    // Show popup
    function showPopup(message) {
      document.getElementById('popupMessage').textContent = message;
      document.getElementById('popup').style.display = 'block';
    }

    // Close popup
    function closePopup() {
      document.getElementById('popup').style.display = 'none';
      const nextPage = parseInt(document.getElementById('popup').dataset.nextPage);
      showPage(nextPage);
    }

    // Initialization
    window.onload = function() {
      initializeSelects();
      showPage(1);
    };
  </script>
</body>
</html>
